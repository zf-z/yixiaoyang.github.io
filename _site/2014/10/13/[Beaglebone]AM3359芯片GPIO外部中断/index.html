<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>[Beaglebone] AM3359芯片GPIO外部中断</title>
  <meta name="description" content="AM3359芯片的GPIO外部中断实现比较简单，可参照ti-sdk-am335x-evm-06.00.00.00官方SDK内核的gpio_omap.c中关于GPIO IRQ部分实现，基本上就是设置GPIO复用-&gt;设置input方向-&gt;使能中断-&gt;填写中断处理函数槽-&gt;清中断标记位等几个步骤...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="/2014/10/13/%5BBeaglebone%5DAM3359%E8%8A%AF%E7%89%87GPIO%E5%A4%96%E9%83%A8%E4%B8%AD%E6%96%AD/">
  <link rel="alternate" type="application/rss+xml" title="Leon's Blog" href="/feed.xml" />
  <link rel="stylesheet" type="text/css" href="http://apps.bdimg.com/libs/bootstrap/3.3.0/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="/css/custom.css">
  <link rel="stylesheet" type="text/css" href="/css/_syntax-highlighting.css">
  <!-- 返回顶部 -->
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
  <script type="text/javascript" src="http://apps.bdimg.com/libs/jquery/2.1.1/jquery.min.js"></script>
  <script type="text/javascript" src="http://apps.bdimg.com/libs/bootstrap/3.3.0/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="/js/index.js"></script>
  <link rel="stylesheet" type="text/css" href="http://apps.bdimg.com/libs/highlight.js/8.6/styles/magula.min.css">
  <script type="text/javascript" src="http://apps.bdimg.com/libs/highlight.js/8.4/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Leon's Blog</a>
    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/AboutMe.html">关于我</a>
          
        
          
        
          
        
          
        
          
          <a class="page-link" href="/message.html">留言板</a>
          
        
      </div>
   </nav>
 </div>

  <HR style="FILTER: alpha(opacity=100,finishopacity=0,style=3)" width="100%" color=#987cb9 SIZE=3>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">[Beaglebone] AM3359芯片GPIO外部中断</h1>
    <p class="post-meta">2014-10-13 • leon_e@163.com</p>
  </header>


  <div class="tags_div">
  
	
	  <span class="tags_span">Beaglebone</span>
	
	  <span class="tags_span">C</span>
	
	  <span class="tags_span">嵌入式</span>
	
	  <span class="tags_span">编程</span>
	
  
 </div>
 

  <article class="post-content">
    <p>AM3359芯片的GPIO外部中断实现比较简单，可参照ti-sdk-am335x-evm-06.00.00.00官方SDK内核的<code>gpio_omap.c</code>中关于GPIO IRQ部分实现，基本上就是设置GPIO复用-&gt;设置input方向-&gt;使能中断-&gt;填写中断处理函数槽-&gt;清中断标记位等几个步骤。需要理解的异步通知fasync的使用，这是中断等信号传递到用户空间的常用方法。</p>

<h4 id="驱动方面">驱动方面</h4>

<ol>
<li>在设备抽象的数据结构中增加一个<code>struct fasync_struct</code>的指针</li>
<li>实现设备操作中的fasync函数，主体就是调用内核的<code>fasync_helper</code>函数。</li>
<li>在需要向用户空间通知的地方(例如中断中)调用内核的<code>kill_fasync</code>函数发送信号。</li>
<li>在驱动的release方法中调用前面定义的fasync函数fasync(-1, fd, 0)以删除释放通知。</li>
</ol>

<h4 id="应用层方面">应用层方面</h4>

<ol>
<li>利用signal或者sigaction设置SIGIO信号的处理函数</li>
<li>fcntl的<code>F_SETOWN</code>指令设置当前进程为设备文件owner</li>
<li>fcntl的<code>F_SETFL</code>指令设置FASYNC标志</li>
</ol>

<p>为测试外部驱动，我让硬件工程师接了一个下拉电阻，但是拨上开关后出现了外部中断一直触发的现象，之后用示波器抓了GPIO端口的波形发现噪声太大，有时都能超过2v，遂使用一般按键的方法外接电容处理减少噪声，中断才一次按键一次中断响应。</p>

<p>驱动和应用层代码如下。</p>
<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#include &lt;linux/kernel.h&gt;  </span>
<span class="cp">#include &lt;linux/module.h&gt;  </span>
<span class="cp">#include &lt;linux/cdev.h&gt;  </span>
<span class="cp">#include &lt;linux/fs.h&gt;  </span>
<span class="cp">#include &lt;linux/device.h&gt;  </span>
<span class="cp">#include &lt;linux/syscalls.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt; </span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/of_gpio.h&gt;</span>
<span class="cp">#include &lt;linux/of_platform.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;  </span>
<span class="cp">#include &lt;linux/string.h&gt; </span>

<span class="cp">#include &lt;mach/gpio.h&gt;</span>
<span class="cp">#include &lt;mach/irqs.h&gt;</span>

<span class="cp">#include &lt;plat/gpio.h&gt;</span>
<span class="cp">#include &lt;plat/am33xx.h&gt;</span>

<span class="cp">#define GPIO_TO_PIN(bank, gpio)     (32 * (bank) + (gpio))</span>
<span class="cp">#define IRQ_GPIO_PIN                GPIO_TO_PIN(1, 13)</span>

<span class="cp">#define   TRIGGERD_FLAG_IRQ_DISABLED        (1&lt;&lt;0)</span>
<span class="cp">#define   TRIGGERD_FLAG_IRQ_ENABLED         (1&lt;&lt;1)</span>

<span class="cm">/* cmd definations shouled be same with that in user space */</span>
<span class="cp">#define MAGIC_NUM   &#39;k&#39;</span>
<span class="k">enum</span> <span class="n">IOCTL_CMDS</span><span class="p">{</span>
  <span class="n">IOCTL_CMD_IRQ_NONE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">IOCTL_CMD_IRQ_DISABLE</span> <span class="o">=</span> <span class="n">_IO</span><span class="p">(</span><span class="n">MAGIC_NUM</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
  <span class="n">IOCTL_CMD_IRQ_ENABLE</span>  <span class="o">=</span> <span class="n">_IO</span><span class="p">(</span><span class="n">MAGIC_NUM</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">fpga_key_dev</span>  
<span class="p">{</span>  
    <span class="k">struct</span> <span class="n">cdev</span> <span class="n">cdev</span><span class="p">;</span>  
    <span class="kt">dev_t</span> <span class="n">devno</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">class</span> <span class="o">*</span><span class="n">fpga_key_class</span><span class="p">;</span> 
    <span class="k">struct</span> <span class="n">fasync_struct</span> <span class="o">*</span><span class="n">async_queue</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">message_cdev_open</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">irq_no</span><span class="p">;</span> 
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">triggered_flags</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">fpga_key_dev</span> <span class="n">fpga_key_dev</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">irq_enable</span><span class="p">(</span> <span class="k">struct</span> <span class="n">fpga_key_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">;</span>

  <span class="k">switch</span><span class="p">(</span><span class="n">enable</span><span class="p">){</span>
    <span class="k">case</span> <span class="n">IOCTL_CMD_IRQ_ENABLE</span><span class="o">:</span>
      <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;enable irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">enable_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_no</span><span class="p">);</span>
      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">triggered_flags</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">TRIGGERD_FLAG_IRQ_DISABLED</span><span class="p">);</span>
      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">triggered_flags</span> <span class="o">|=</span> <span class="n">TRIGGERD_FLAG_IRQ_ENABLED</span><span class="p">;</span>  
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">IOCTL_CMD_IRQ_DISABLE</span><span class="o">:</span>
      <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;disable irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">disable_irq_nosync</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_no</span><span class="p">);</span>
      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">triggered_flags</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">TRIGGERD_FLAG_IRQ_ENABLED</span><span class="p">);</span>
      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">triggered_flags</span> <span class="o">|=</span> <span class="n">TRIGGERD_FLAG_IRQ_DISABLED</span><span class="p">;</span>  
      <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;irq_enable finished</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">irqreturn_t</span> <span class="nf">irq_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irqno</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">fpga_key_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fpga_key_dev</span><span class="p">;</span>

    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;fpga int triggered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">async_queue</span><span class="p">)</span>
        <span class="n">kill_fasync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">async_queue</span><span class="p">,</span> <span class="n">SIGIO</span><span class="p">,</span> <span class="n">POLL_IN</span><span class="p">);</span> 

    <span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fpga_key_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">fd</span><span class="p">)</span>  
<span class="p">{</span>  
    <span class="k">struct</span> <span class="n">fpga_key_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

    <span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">i_cdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fpga_key_dev</span><span class="p">,</span> <span class="n">cdev</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">message_cdev_open</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">dev</span><span class="o">-&gt;</span><span class="n">message_cdev_open</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">fd</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span><span class="p">{</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  
<span class="p">}</span>   

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">fpga_key_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">loff_t</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>  
<span class="p">{</span>  
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  
<span class="p">}</span>  
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">fpga_key_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">fd</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">loff_t</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>  
<span class="p">{</span>  
    <span class="k">struct</span> <span class="n">fpga_key_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fd</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">){</span>
      <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;read length too small&quot;</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">EFAULT</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">triggered_flags</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>  
        <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>  
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  
<span class="p">}</span>  

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fpga_key_fasync</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">fpga_key_dev</span>     <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
    <span class="n">fasync_helper</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">filp</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">async_queue</span><span class="p">);</span> 
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fpga_key_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">fd</span><span class="p">)</span>  
<span class="p">{</span>  
    <span class="k">struct</span> <span class="n">fpga_key_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fd</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">message_cdev_open</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">fpga_key_fasync</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  
<span class="p">}</span> 


<span class="k">static</span> <span class="kt">int</span> <span class="nf">fpga_key_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">args</span><span class="p">)</span>  
<span class="p">{</span>  
    <span class="k">struct</span> <span class="n">fpga_key_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fd</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">){</span>
      <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dev data null&quot;</span><span class="p">);</span>
      <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">switch</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>  
    <span class="p">{</span>  
        <span class="k">case</span> <span class="n">IOCTL_CMD_IRQ_NONE</span><span class="o">:</span>  
          <span class="k">break</span><span class="p">;</span>  
        <span class="k">case</span> <span class="n">IOCTL_CMD_IRQ_DISABLE</span><span class="o">:</span>  
          <span class="n">irq_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IOCTL_CMD_IRQ_DISABLE</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>  
        <span class="k">case</span> <span class="n">IOCTL_CMD_IRQ_ENABLE</span><span class="o">:</span>
          <span class="n">irq_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IOCTL_CMD_IRQ_ENABLE</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="nl">default:</span>  
          <span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>  
          <span class="k">break</span><span class="p">;</span>  
    <span class="p">}</span>  
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  
<span class="p">}</span>

<span class="k">struct</span> <span class="n">file_operations</span> <span class="n">meassage_operatons</span> <span class="o">=</span>  
<span class="p">{</span>  
    <span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>  
    <span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">fpga_key_open</span><span class="p">,</span>  
    <span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">fpga_key_write</span><span class="p">,</span>
    <span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">fpga_key_read</span><span class="p">,</span> 
    <span class="p">.</span><span class="n">fasync</span> <span class="o">=</span> <span class="n">fpga_key_fasync</span><span class="p">,</span>
    <span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">fpga_key_release</span><span class="p">,</span>  
    <span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span> <span class="n">fpga_key_ioctl</span><span class="p">,</span>
<span class="p">};</span>  

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">fpga_key_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>  
<span class="p">{</span>  
    <span class="k">struct</span> <span class="n">fpga_key_dev</span> <span class="o">*</span> <span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fpga_key_dev</span><span class="p">;</span>  
    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">gpio_lable</span> <span class="o">=</span> <span class="s">&quot;fpga_msg_irq_key&quot;</span><span class="p">;</span>

    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">triggered_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">alloc_chrdev_region</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;fpga_msg_irq&quot;</span><span class="p">);</span>  
    <span class="n">cdev_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">meassage_operatons</span><span class="p">);</span>  
    <span class="n">cdev_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>  

    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">fpga_key_class</span> <span class="o">=</span> <span class="n">class_create</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">,</span> <span class="s">&quot;fpga_msg_irq_class&quot;</span><span class="p">);</span>  
    <span class="k">if</span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fpga_key_class</span><span class="p">))</span> <span class="p">{</span>  
         <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;failed in creating class./n&quot;</span><span class="p">);</span>  
         <span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>   
     <span class="p">}</span>  
    <span class="n">device_create</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fpga_key_class</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;fpga_msg_irq_dev&quot;</span><span class="p">);</span>  

    <span class="cm">/* gpio interrupt request */</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">IRQ_GPIO_PIN</span><span class="p">,</span> <span class="n">gpio_lable</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">ret</span><span class="p">){</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;gpio_request() failed !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_direction_input</span><span class="p">(</span><span class="n">IRQ_GPIO_PIN</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">ret</span><span class="p">){</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;gpio_direction_input() failed !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span> 
    <span class="p">}</span>

    <span class="n">irq</span> <span class="o">=</span> <span class="n">gpio_to_irq</span><span class="p">(</span><span class="n">IRQ_GPIO_PIN</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;gpio_to_irq() failed !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
        <span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span> 
    <span class="p">}</span>
    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_no</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">   ret = request_irq(dev-&gt;irq_no, </span>
<span class="c">                    irq_handler, </span>
<span class="c">                    IRQF_TRIGGER_RISING | IRQF_SHARED, </span>
<span class="c">                    gpio_lable, </span>
<span class="c">                    &amp;dev-&gt;devno); </span>
<span class="cp">#else</span>
   <span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_no</span><span class="p">,</span> 
                    <span class="n">irq_handler</span><span class="p">,</span> 
                    <span class="n">IRQF_TRIGGER_RISING</span> <span class="o">|</span> <span class="n">IRQF_DISABLED</span><span class="p">,</span> 
                    <span class="n">gpio_lable</span><span class="p">,</span> 
                    <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">);</span> 
<span class="cp">#endif</span>

    <span class="k">if</span><span class="p">(</span><span class="n">ret</span><span class="p">){</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;request_irq() failed ! %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;fpga_key_to_app_init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>      
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  

<span class="nl">fail2:</span>  
    <span class="n">gpio_free</span><span class="p">(</span><span class="n">IRQ_GPIO_PIN</span><span class="p">);</span>  
<span class="nl">fail1:</span>    
    <span class="n">device_destroy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fpga_key_class</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">);</span>  
    <span class="n">class_destroy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fpga_key_class</span><span class="p">);</span>   
    <span class="n">cdev_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">);</span>  
    <span class="n">unregister_chrdev_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>  

    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>  
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">fpga_key_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>  
<span class="p">{</span>  
    <span class="k">struct</span> <span class="n">fpga_key_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fpga_key_dev</span><span class="p">;</span>  

    <span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_no</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">);</span> 
    <span class="n">gpio_free</span><span class="p">(</span><span class="n">IRQ_GPIO_PIN</span><span class="p">);</span>

    <span class="n">device_destroy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fpga_key_class</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">);</span>  
    <span class="n">class_destroy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fpga_key_class</span><span class="p">);</span>   
    <span class="n">cdev_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">);</span>  
    <span class="n">unregister_chrdev_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>  

    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;fpga_key_to_app_exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>  
<span class="p">}</span>  
<span class="n">module_init</span><span class="p">(</span><span class="n">fpga_key_init</span><span class="p">);</span>  
<span class="n">module_exit</span><span class="p">(</span><span class="n">fpga_key_exit</span><span class="p">);</span>  

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>  
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;hityixiaoyang@gmail.com&quot;</span><span class="p">);</span>  
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;AM335x GPIO IQR for FPGA&quot;</span><span class="p">);</span>  






<span class="cm">/*</span>
<span class="cm"> * linux异步通知类似于中断，程序开始做的就是将想监测的文件设置为异步通知，然后程序就去做别的事情了，</span>
<span class="cm"> * 当这些文件上面有数据可读时候，就发送一个信号，程序接受到这个信号就去处理这个文件的数据。</span>
<span class="cm"> * 这样程序不再是主动去读文件了，而是以类型于中断的方式，这样程序更加灵活。</span>
<span class="cm"> * </span>
<span class="cm"> * 要弄清linux异步通知必须要弄明白一下几件事:</span>
<span class="cm"> * 1.谁发信号</span>
<span class="cm"> * 2.发给谁</span>
<span class="cm"> * 3.接受到信号怎么办</span>
<span class="cm"> */</span>
<span class="cp">#include&lt;stdio.h&gt;  </span>
<span class="cp">#include&lt;sys/types.h&gt;  </span>
<span class="cp">#include&lt;sys/stat.h&gt;  </span>
<span class="cp">#include&lt;fcntl.h&gt;  </span>
<span class="cp">#include&lt;sys/select.h&gt;  </span>
<span class="cp">#include&lt;unistd.h&gt;  </span>
<span class="cp">#include&lt;signal.h&gt;  </span>
<span class="cp">#include&lt;string.h&gt;  </span>
<span class="cp">#include&lt;linux/ioctl.h&gt;</span>

<span class="cp">#define FPIO_IRQ_DEV_NAME   &quot;/dev/fpga_msg_irq_dev&quot;</span>

<span class="cp">#define MAGIC_NUM   &#39;k&#39;</span>
<span class="k">enum</span> <span class="n">IOCTL_CMDS</span><span class="p">{</span>
  <span class="n">IOCTL_CMD_IRQ_NONE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">IOCTL_CMD_IRQ_DISABLE</span> <span class="o">=</span> <span class="n">_IO</span><span class="p">(</span><span class="n">MAGIC_NUM</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
  <span class="n">IOCTL_CMD_IRQ_ENABLE</span>  <span class="o">=</span> <span class="n">_IO</span><span class="p">(</span><span class="n">MAGIC_NUM</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
<span class="p">};</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  
<span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">sig_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">)</span>  
<span class="p">{</span>  
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;[pid %d] %s recieved signal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">getpid</span><span class="p">(),</span><span class="n">__FUNCTION__</span><span class="p">);</span>  
<span class="p">}</span>  

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>  
<span class="p">{</span>  
    <span class="kt">int</span> <span class="n">f_flags</span><span class="p">;</span> 
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">number</span><span class="p">;</span> 

    <span class="n">fd</span><span class="o">=</span><span class="n">open</span><span class="p">(</span><span class="n">FPIO_IRQ_DEV_NAME</span><span class="p">,</span><span class="n">O_RDWR</span><span class="p">);</span>  
    <span class="k">if</span><span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>  
        <span class="n">perror</span><span class="p">(</span><span class="s">&quot;open gpio irq device failed&quot;</span><span class="p">);</span>  
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>  
    <span class="p">}</span>  

    <span class="n">signal</span><span class="p">(</span><span class="n">SIGIO</span><span class="p">,</span> <span class="n">sig_handler</span><span class="p">);</span> 
    <span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">F_SETOWN</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>

   <span class="cm">/* </span>
<span class="cm">    * 设置该文件的标志为FASYNC,设置文件的标志为FASYNC将导致驱动程序的fasync被调用</span>
<span class="cm">    * 这样文件就开始处于异步通知状态了</span>
<span class="cm">    */</span>
    <span class="n">f_flags</span> <span class="o">=</span> <span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">F_GETFL</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;waiting for signal </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 
    <span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">F_SETFL</span><span class="p">,</span> <span class="n">FASYNC</span> <span class="o">|</span> <span class="n">f_flags</span><span class="p">);</span> 

    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">){</span>
      <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">number</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">));</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;key count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">number</span><span class="p">);</span>
      <span class="n">sleep</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span> 
    <span class="p">}</span>

    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>  

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;main exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  
<span class="p">}</span>  
</code></pre></div>
  </article>


  <HR style="FILTER: alpha(opacity=100,finishopacity=0,style=3)" width="100%" color=#987cb9 SIZE=3>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
	 /* * * CONFIGURATION VARIABLES * * */
  var disqus_shortname = 'leon-blog';

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
   })();
  </script>


</div>

      </div>
    </div>

    <div id="top" data-toggle="tooltip" data-placement="left" title="Top">
      <a href="javascript:;">
        <div class="arrow"></div>
        <div class="stick"></div>
      </a>
    </div>
    
    <footer class="">
  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <a href="mailto:leon_e@163.com"><span class="glyphicon glyphicon-envelope"></span> leon_e@163.com</a>
        <span class="point"> · </span>
        
          <a href="https://github.com/yixiaoyang">
            <span class="icon">
              <svg viewBox="0 0 16 16">
                <path fill="#aaa" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>
            Github
          </a>
          
          
          <span class="point"> · </span>
          <span><a href="/feed.xml">RSS</a></span>
          <span class="point"> · </span>
          <span>Embedded System, Linux, Python & Ruby</span>
          <span class="point"> · </span>
          <span class="point"> . </span>
      </div>
      <div><span> <a href="https://www.upyun.com/"><img src="http://upfiles.b0.upaiyun.com/logo/90x45.png" alt="UPYUN"></a></span></div>
    </div>
  </div>
</footer>
 </body> 
</html>
